<!DOCTYPE html>
<html lang="en">
<!-- @author: Weidong Yang -->
<script type="x-shader/x-vertex" id="vertexshaderParticle">
    uniform float amplitude; attribute float size; attribute vec3 customColor; varying vec3 vColor; void main() { vColor = customColor; vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 ); gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ) ); gl_Position = projectionMatrix * mvPosition; }
</script>
<!-- @author: Weidong Yang -->
<script type="x-shader/x-fragment" id="fragmentshaderParticle">
    uniform vec3 color; uniform sampler2D texture; uniform vec2 offset; varying vec3 vColor; void main() { gl_FragColor = vec4( color * vColor, 1.0 ); gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord + offset ); }
</script>

<head>
    <title>three.js - pointerlock controls</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="assets/css/test.css">
</head>

<body>
    <script src="assets/js/THREE/config.js"></script>
    <script src="assets/js/THREE/three.min.js"></script>
    <script src="assets/js/THREE/PointerLockControls.js"></script>
    <script src="assets/js/THREE/pointCloud.js"></script>
    <div id="blocker">
        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br /> (W, A, S, D = Move, SPACE = Up, SHIFT = Down, MOUSE = Look around)
        </div>
    </div>
    <script>
    var pointCloud = null;
    var worldSize = 10000;

    var camera, scene, renderer;
    var geometry, material, mesh;
    var controls;

    var objects = [];

    var raycaster;

    var blocker = document.getElementById('blocker');
    var instructions = document.getElementById('instructions');

    // http://www.html5rocks.com/en/tutorials/pointerlock/intro/

    var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

    if (havePointerLock) {

        var element = document.body;

        var pointerlockchange = function(event) {

            if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {

                controlsEnabled = true;
                controls.enabled = true;

                blocker.style.display = 'none';

            } else {

                controls.enabled = false;

                blocker.style.display = '-webkit-box';
                blocker.style.display = '-moz-box';
                blocker.style.display = 'box';

                instructions.style.display = '';

            }

        };

        var pointerlockerror = function(event) {

            instructions.style.display = '';

        };

        // Hook pointer lock state change events
        document.addEventListener('pointerlockchange', pointerlockchange, false);
        document.addEventListener('mozpointerlockchange', pointerlockchange, false);
        document.addEventListener('webkitpointerlockchange', pointerlockchange, false);

        document.addEventListener('pointerlockerror', pointerlockerror, false);
        document.addEventListener('mozpointerlockerror', pointerlockerror, false);
        document.addEventListener('webkitpointerlockerror', pointerlockerror, false);

        instructions.addEventListener('click', function(event) {

            instructions.style.display = 'none';

            // Ask the browser to lock the pointer
            element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
            element.requestPointerLock();

        }, false);

    } else {

        instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

    }

    init();
    animate();

    var controlsEnabled = false;

    var moveForward = false;
    var moveBackward = false;
    var moveLeft = false;
    var moveRight = false;
    var moveUp = false;
    var moveDown = false;
    var canJump = false;

    var prevTime = performance.now();
    var velocity = new THREE.Vector3();

    function init() {

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);

        scene = new THREE.Scene();

        controls = new THREE.PointerLockControls(camera);
        console.log(controls.getObject());
        scene.add(controls.getObject());

        var geometry = new THREE.BoxGeometry(5, 5, 5);
        var material = new THREE.MeshBasicMaterial();
        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        //Create a second PointCloud to fill the scene with particles
        pointCloud = new PointCloud(scene);

        pointCloud.maxParticles = 50000;

        //Sets value that determines how the particles span the space
        // pointCloud.fieldSize = worldSize;

        //Adds particles to the scene
        pointCloud.addBatch(100);
        console.log(scene);

        var onKeyDown = function(event) {

            switch (event.keyCode) {

                case 38: // up
                case 87: // w
                    moveForward = true;
                    break;

                case 37: // left
                case 65: // a
                    moveLeft = true;
                    break;

                case 40: // down
                case 83: // s
                    moveBackward = true;
                    break;

                case 39: // right
                case 68: // d
                    moveRight = true;
                    break;

                case 16: // shift
                    moveDown = true;
                    break;

                case 32: // space
                    moveUp = true;
                    break;

            }

        };

        var onKeyUp = function(event) {

            switch (event.keyCode) {

                case 38: // up
                case 87: // w
                    moveForward = false;
                    break;

                case 37: // left
                case 65: // a
                    moveLeft = false;
                    break;

                case 40: // down
                case 83: // s
                    moveBackward = false;
                    break;

                case 39: // right
                case 68: // d
                    moveRight = false;
                    break;

                case 16: // shift
                    moveDown = false;
                    break;

                case 32: // space
                    moveUp = false;
                    break;

            }

        };

        // initSkybox();

        var light = new THREE.HemisphereLight(0xd1f8ff, 0x777788, 0.5);
        scene.add(light);
        // directionalLight = new THREE.PointLight(0xd1f8ff);
        // directionalLight.position.set(0, 500, 500);
        // scene.add(directionalLight);

        // //Create a second PointCloud to fill the scene with particles
        // pointCloud = new PointCloud(scene);

        // pointCloud.maxParticles = 50000;

        // //Sets value that determines how the particles span the space
        // pointCloud.fieldSize = worldSize;

        // //Adds particles to the scene
        // pointCloud.addBatch(20000);

        document.addEventListener('keydown', onKeyDown, false);
        document.addEventListener('keyup', onKeyUp, false);

        raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 0, 10);

        //

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        // document.body.appendChild(renderer.domElement);

        //

        window.addEventListener('resize', onWindowResize, false);

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);

    }

    function animate() {

        requestAnimationFrame(animate);
        pointCloud.update();

        if (controlsEnabled) {
            controls.update();
        }

        renderer.render(scene, camera);

    }
    </script>
</body>

</html>
